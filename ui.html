<!DOCTYPE html>
<html>

<head>
    <title></title>
    <meta charset='utf-8'>
    <style>
        body {
            margin: 0;
        }

        .canvas-container {
            position: relative;
            width: 500px;
            height: 500px;
        }

        canvas {
            position: absolute;
            position: absolute;
            left: 0px;
            top: 0px;
        }

        table {
            position: absolute;
            left: 0%;
            top: 0%;
            z-index: 3;
        }

        button {
            background-color: #1e45f4;
            border: none;
            color: black;
            width: 180px;
            padding: 16px 32px;
            text-align: center;
            font-size: 16px;
            margin: 4px 2px;
            opacity: 0.6;
            transition: 0.3s;
            border: 5px;
            border-color: black;
            display: inline-block;
            cursor: pointer;
        }

        button:hover {
            opacity: 1
        }
    </style>

    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
</head>

<body>
    <div class="canvas-container">
        <canvas id='paint_layer' style='z-index: 1;'></canvas>
        <canvas id='word_layer' style='z-index: 2;'></canvas>
    </div>

    <div>
        <table>
            <tr>
                <th>Effects</th>
                <th></th>
            </tr>
            <tr>
                <td><button value="Rainbow">Rainbow</button>
                </td>
            </tr>
            <tr>
                <td><button>Rain</button></td>
            </tr>
            <tr>
                <td><button value="Bounce">Bounce</button></td>
            </tr>
            <tr>
                <td><button>Paint</button></td>
            </tr>
            <tr>
                <td><input type='color' id='color'></button></td>
            </tr>
            <tr>
                <td><button type='button' id='reset'>Reset Canvas</button></td>
            </tr>
        </table>


    </div>
    <script>
        // Main Function 
        (function (w, d) {
            'use strict';

            var action = 'up',
                canvas = d.querySelector('#paint_layer'),
                paint_ctx = canvas.getContext('2d'),
                words = d.querySelector('#word_layer'),
                words_ctx = words.getContext('2d'),
                color = d.querySelector('#color'),
                record = d.querySelector('#record'),
                body = d.querySelector('body'),
                offset = 1000,
                points = [],
                bufer = paint_ctx.getImageData(0, 0, canvas.width, canvas.height),
                radio_selection = 'Paint',
                led_counts = { 0: 151, 1: 57, 2: 10, 3: 10, 4: 10, 5: 10, 6: 10, 7: 10, 8: 10, 9: 10 },
                control_points = { 0: [[0, 0]], 1: [[0, 0]], 2: [[0, 0]], 3: [[0, 0]], 4: [[0, 0]], 5: [[0, 0]], 6: [[0, 0]], 7: [[0, 0]], 8: [[0, 0]], 9: [[0, 0]] },
                point_history = {};
            paint_ctx.shadowColor = '#000000';
            canvas.height = w.innerHeight;
            canvas.width = w.innerWidth;
            words.height = w.innerHeight;
            words.width = w.innerWidth;
            // Setup initial text borders 
            words_ctx.lineWidth = 3;
            words_ctx.strokeStyle = 'black';
            words_ctx.font = ' 250px serif';
            words_ctx.strokeText('MakerSPACe', 0, canvas.height / 2);

            // Arduino Command Tools 
            const buffer = new ArrayBuffer(5);
            // var connection = new WebSocket('ws://' + w.location.hostname + ':81/', ['arduino']);
            // connection.onopen = function () {
            //     connection.send('Connect ' + new Date());
            // };
            // connection.onerror = function (error) {
            //     console.log('WebSocket Error ', error);
            // };
            // connection.binaryType = 'arraybuffer';
            // connection.onmessage = function (e) {
            //     console.log('Server: ', e.data);
            // };
            // connection.onclose = function () {
            //     console.log('WebSocket connection closed');
            // };

            function samplePoint(x, y) {
                var img_data = paint_ctx.getImageData(x, y, 1, 1).data;
                var R = img_data[0];
                var G = img_data[1];
                var B = img_data[2];
                return [R, G, B];
            }
            function sampleCapturePoints() {
                for (const [device_num, points] of Object.entries(control_points)) {
                    for (const [index, point] of Object.entries(points)) {
                        var rgb = samplePoint(point[0], point[1]);
                        var led_ind = device_num.toString() + index.toString().padStart(3, "0");
                        var cmd = rgb[0].toString().padStart(3, "0") + rgb[1].toString().padStart(3, "0") + rgb[2].toString().padStart(3, "0");
                        var bytearray = new Uint8Array(buffer);
                        bytearray[0] = device_num;
                        bytearray[1] = index;
                        bytearray[2] = rgb[0];
                        bytearray[3] = rgb[1];
                        bytearray[4] = rgb[2];

                        if (point_history[led_ind] != cmd) {
                            // if (connection.readyState === WebSocket.OPEN) {
                            //     connection.send(bytearray.buffer);
                            // } else {
                            console.log(bytearray);
                            // }
                            point_history[led_ind] = cmd;
                        }
                    }
                }
            }

            // Paint Tools 
            function resetCanvas() {
                paint_ctx.clearRect(0, 0, canvas.width, canvas.height);
                paint_ctx.lineWidth = 50;
                paint_ctx.shadowBlur = 100;
                bufer = paint_ctx.getImageData(0, 0, canvas.width, canvas.height);
            }

            function runCanvas() {
                if (points.length > 0) {
                    if (radio_selection == 'Paint') { // Painting 
                        paint_ctx.beginPath();
                        paint_ctx.moveTo(points[0][0] + offset, points[0][1]);
                        for (var i = 1; i < points.length; i++) {
                            paint_ctx.lineTo(points[i][0] + offset, points[i][1]);
                        }
                    } else {
                        paint_ctx.beginPath();
                        for (var i = 1; i < points.length; i++) {
                            paint_ctx.rect(points[i][0] + offset, points[i][1], 3, 3);
                        }
                    }
                }
                sampleCapturePoints();
                setTimeout(runCanvas, 1000 / 24); // drawing at 24fps
            }
            d.getElementById('reset').onclick = resetCanvas;

            body.addEventListener('mouseup', function () {
                action = 'up';
                points = [];
                bufer = paint_ctx.getImageData(0, 0, canvas.width, canvas.height);
            });

            body.addEventListener('mousedown', function (e) {
                action = 'down';
                points.push([e.pageX, e.pageY]);
            });

            body.addEventListener('mousemove', function (e) {
                if (action === 'down') {
                    paint_ctx.putImageData(bufer, 0, 0); // Redraw Previous Frame 
                    points.push([e.pageX, e.pageY]);
                }
            });

            color.addEventListener('change', function (e) {
                paint_ctx.shadowColor = e.target.value;
            });

            //////////////////// ALL EFFECTS
            var effect = "";
            // Rainbow Effect

            var angle = Math.random() * 360,        // start angle (for HSL)
                angleDlt = 60,                    // 60° ahead
                step = 1;                            // "speed" for change

            function createRainbowGradient() {
                var gr = paint_ctx.createLinearGradient(0, 0, canvas.width / 2, 0);               // create gradient
                gr.addColorStop(0, "hsl(" + (angle % 360) + ",100%, 50%)");    // start color
                gr.addColorStop(0.5, "hsl(" + ((angle + (angleDlt / 2)) % 360) + ",100%, 50%)");
                gr.addColorStop(1, "hsl(" + ((angle + angleDlt) % 360) + ",100%, 50%)");
                paint_ctx.fillStyle = gr;                                            // set as fill style
                paint_ctx.fillRect(0, 0, canvas.width, canvas.height);                                  // fill area   
                angle += step;
                if (effect == "Rainbow") {
                    requestAnimationFrame(createRainbowGradient);
                }
            }


            // Bounce Effect 
            var angle = 0;
            function drawCircle() {
                paint_ctx.clearRect(0, 0, canvas.width, canvas.height);

                // color in the background
                paint_ctx.fillStyle = "#EEEEEE";
                paint_ctx.fillRect(0, 0, canvas.width, canvas.height);

                // draw the circle
                paint_ctx.beginPath();

                var radius = 25 + 500 * Math.abs(Math.cos(angle));
                paint_ctx.shadowBlur = 1;
                paint_ctx.shadowOffsetX = 0;
                paint_ctx.arc(canvas.width / 3, canvas.height / 2, radius, 0, Math.PI * 2, false);
                paint_ctx.closePath();

                // color in the circle
                paint_ctx.fillStyle = paint_ctx.shadowColor;
                paint_ctx.fill();

                angle += Math.PI / 128;
                if (effect == "Bounce") {
                    requestAnimationFrame(drawCircle);
                }
            }
            $("button").click(function () {

                if ($(this).val() == "Rainbow" && effect != "Rainbow") {
                    angle = Math.random() * 360,        // start angle (for HSL)
                        angleDlt = 60,                    // 60° ahead
                        step = 1;
                    requestAnimationFrame(createRainbowGradient);
                }

                if ($(this).val() == "Bounce" && effect != "Bounce") {

                    angle = 0;

                    requestAnimationFrame(drawCircle);
                }
                if ($(this).val() == "Paint" && effect != "Paint") {

                    //requestAnimationFrame(drawCircle);
                }
                if ($(this).val() == "" && effect != "") {

                    resetCanvas();
                }
                effect = $(this).val();
            });
            runCanvas();

        }(window, document));

    </script>

</body>

</html>